<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recognition Example</title>
    <style>
        .chat-container {
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: auto;
            height: 400px;
        }
        .chat-bubble {
            display: block;
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .user-bubble {
            background-color: #dcf8c6;
            align-self: flex-start;
        }
        .response-bubble {
            background-color: #f0f0f0;
            align-self: flex-end;
        }
        .waiting-bubble {
            background-color: #eee;
            font-style: italic;
            align-self: flex-end;
        }
    </style>
</head>
<body>
    <h1>음성 인식 예제</h1>
    <p>마이크에 대고 말하세요...</p>
    <div class="chat-container" id="chat-container"></div>
    <script>
        // Web Speech API 지원 여부 확인
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true; // 음성 인식을 계속 수행
            recognition.interimResults = false; // 중간 결과를 허용하지 않음
            recognition.lang = 'ko-KR'; // 한국어 설정

            recognition.onstart = function() {
                console.log("음성 인식 시작...");
            };

            recognition.onresult = function(event) {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const recognizedText = event.results[i][0].transcript;
                        console.log("Google 음성 인식이 이렇게 들었습니다: " + recognizedText);

                        // 사용자가 말한 내용을 왼쪽 말풍선으로 추가
                        addChatBubble(recognizedText, 'user-bubble');

                        // 응답을 기다리는 동안 말풍선 추가
                        const waitingBubble = addChatBubble('응답을 기다리는 중...', 'waiting-bubble');

                        // 서버로 텍스트 전송
                        fetch('/question', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ text: recognizedText })
                        })
                        .then(response => response.json())
                        .then(data => {
                            // 응답 받은 후 대기 말풍선 제거
                            waitingBubble.remove();

                            // 서버 응답을 오른쪽 말풍선으로 추가
                            addChatBubble(data.response, 'response-bubble');

                            // 서버 응답을 TTS로 말하기
                            speak(data.response);
                        })
                        .catch(error => {
                            console.error("서버 응답 오류: ", error);
                            waitingBubble.innerText = '오류가 발생했습니다.';
                        });
                    }
                }
            };

            recognition.onerror = function(event) {
                console.error("음성 인식 오류: ", event.error);
            };

            recognition.onend = function() {
                console.log("음성 인식이 종료되었습니다. 다시 시작합니다...");
                recognition.start(); // 인식이 종료되면 다시 시작
            };

            recognition.start(); // 음성 인식 시작
        } else {
            console.error("이 브라우저는 Web Speech API를 지원하지 않습니다.");
        }

        function addChatBubble(text, className) {
            const chatContainer = document.getElementById('chat-container');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${className}`;
            bubble.innerText = text;
            chatContainer.appendChild(bubble);
            chatContainer.scrollTop = chatContainer.scrollHeight; // 스크롤을 아래로
            return bubble;
        }

        function speak(text) {
            const synth = window.speechSynthesis;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            synth.speak(utterance);
        }
    </script>
</body>
</html>
